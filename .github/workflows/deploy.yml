name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --no-cache-dir -r requirements.txt
      
      - name: Check for syntax errors
        run: |
          find . -name "*.py" \
            -not -path "./venv*/*" \
            -not -path "./.git/*" \
            -not -path "./__pycache__/*" \
            -exec python -m py_compile {} \;

  deploy-production:
    name: Deploy to Production
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HETZNER_SSH_PRIVATE_KEY }}" > ~/.ssh/hetzner_key
          chmod 600 ~/.ssh/hetzner_key
          ssh-keyscan -H ${{ secrets.HETZNER_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy to Hetzner Kubernetes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REF: ${{ github.ref }}
          SSH_OPTS: "-i ~/.ssh/hetzner_key -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -o ServerAliveCountMax=3 -o ConnectTimeout=30"
        run: |
          echo "=== Deploying to Hetzner Kubernetes ==="
          
          # Upload source code to Hetzner and build there
          echo "=== Uploading source code to Hetzner ==="
          tar --exclude='.git' --exclude='venv' --exclude='__pycache__' --exclude='*.pyc' --exclude='.env' --exclude='instance' --exclude='*.db' --exclude='*.sqlite*' -czf /tmp/gabay-source.tar.gz .
          scp ${SSH_OPTS} /tmp/gabay-source.tar.gz root@${{ secrets.HETZNER_HOST }}:/tmp/
          rm -f /tmp/gabay-source.tar.gz
          
          # Build Docker image directly on Hetzner server
          echo "=== Building Docker image on Hetzner ==="
          ssh ${SSH_OPTS} root@${{ secrets.HETZNER_HOST }} bash -s << DEPLOY_SCRIPT
            set -e
            set -o pipefail
            
            cd /tmp
            rm -rf gabay-build || true
            mkdir -p gabay-build
            cd gabay-build
            tar -xzf /tmp/gabay-source.tar.gz
            rm /tmp/gabay-source.tar.gz
            
            echo "=== Checking disk space before build ==="
            df -h
            echo ""
            echo "=== Cleaning up Docker resources ==="
            docker system prune -af --volumes || true
            docker builder prune -af || true
            echo ""
            echo "=== Disk space after cleanup ==="
            df -h
            echo ""
            
            echo "Removing old gabay images..."
            docker rmi gabay:latest 2>/dev/null || true
            
            echo "Building Docker image..."
            docker build -t gabay:latest . || {
              echo "Docker build failed"
              exit 1
            }
            
            echo "Importing image into k3s..."
            docker save gabay:latest | k3s ctr images import - || {
              echo "Image import failed"
              exit 1
            }
            
            echo "Cleaning up Docker images after import..."
            docker rmi gabay:latest 2>/dev/null || true
            docker system prune -f || true
            
            echo "Applying Kubernetes manifests..."
            if [ ! -d "/tmp/gabay-k8s" ]; then
              mkdir -p /tmp/gabay-k8s
            fi
            cp -r k8s/* /tmp/gabay-k8s/ 2>/dev/null || true
            
            # Apply manifests if they exist
            if [ -d "/tmp/gabay-k8s" ] && [ "$(ls -A /tmp/gabay-k8s/*.yaml 2>/dev/null)" ]; then
              kubectl apply -f /tmp/gabay-k8s/namespace.yaml || true
              kubectl apply -f /tmp/gabay-k8s/deployment.yaml || true
              kubectl apply -f /tmp/gabay-k8s/service.yaml || true
              kubectl apply -f /tmp/gabay-k8s/ingress.yaml || true
              
              echo "Restarting deployment..."
              kubectl rollout restart deployment/gabay-app -n gabay || {
                echo "Deployment restart failed"
                exit 1
              }
              
              kubectl rollout status deployment/gabay-app -n gabay --timeout=120s || {
                echo "Deployment status check timed out"
              }
            else
              echo "Kubernetes manifests not found, skipping kubectl apply"
            fi
            
            echo "Cleaning up..."
            cd /
            rm -rf /tmp/gabay-build
            rm -rf /tmp/gabay-k8s
            
            echo "Deployment complete"
          DEPLOY_SCRIPT
      
      - name: Verify deployment
        run: |
          sleep 10
          curl -f ${{ secrets.HETZNER_APP_URL || 'https://gabay.janisrael.com' }}/api/health || echo "Health check failed, but deployment may still be in progress"
